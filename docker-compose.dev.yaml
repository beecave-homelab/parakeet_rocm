services:
  parakeet-rocm-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: parakeet-rocm:dev
    container_name: parakeet-rocm-dev
    ports:
      - "7861:7861" # Gradio WebUI
      - "8502:8502" # Streamlit (if needed)
    environment:
      HSA_OVERRIDE_GFX_VERSION: "10.3.0"
      LD_LIBRARY_PATH: "/opt/rocm/lib:/opt/rocm/lib64"
      TZ: "Europe/Amsterdam"
      # Development settings
      PYTHONUNBUFFERED: "1"
      GRADIO_SERVER_NAME: "0.0.0.0"
      GRADIO_SERVER_PORT: "7861"
      # Smaller chunks for faster testing
      BATCH_SIZE: "4"
      CHUNK_LEN_SEC: "60"
      STREAM_CHUNK_SEC: "6"
    devices:
      - "/dev/kfd"
      - "/dev/dri"
    group_add:
      - "video"
    volumes:
      # ---- HOT-RELOAD: Mount source code as volumes ----
      # Changes to these files/directories sync instantly
      - "/opt/rocm:/opt/rocm:ro"
      - "./parakeet_rocm:/app/parakeet_rocm"
      - "./scripts:/app/scripts"
      - "./tests:/app/tests"
      - "./data:/data"
      
      # ---- Config files (optional hot-reload) ----
      - "./pyproject.toml:/app/pyproject.toml:ro"
      - "./.env:/app/.env:ro"
      
      # ---- Prevent node_modules-style pollution ----
      # These prevent host __pycache__ from interfering
      - /app/parakeet_rocm/__pycache__
      - /app/parakeet_rocm/**/__pycache__
    
    # ---- Development commands ----
    # Uncomment the one you want to use:
    
    # Default: WebUI with debug mode
    # command: ["parakeet-rocm", "webui", "--host", "0.0.0.0", "--port", "7861", "--debug"]
    command: ["parakeet-rocm", "webui", "--host", "0.0.0.0", "--port", "7861"]

    # Alternative: Watch mode for auto-transcription
    # command: ["parakeet-rocm", "transcribe", "--watch", "/data/watch/", "--verbose", "--output-format", "srt", "--word-timestamps"]
    
    # Alternative: Interactive shell for manual testing
    # command: ["bash"]
    
    # Alternative: Run tests
    # command: ["pytest", "tests/unit/", "-v"]
    
    restart: unless-stopped
    
    # ---- Optional: Healthcheck for WebUI ----
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7861"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
